# CLAUDE.md - Project Guide for Claude Code

## Project Overview

rpiPan is a CircuitPython steel pan instrument for the Raspberry Pi Pico. It reads a JSON layout file (`pan_layout.json`) to configure notes and hardware, plays WAV samples with polyphonic mixing, and supports velocity-sensitive touch input via an analog multiplexer.

Companion project to [panipuri](https://github.com/profLewis/paniPuri) (desktop Python version).

## Architecture

- **`code.py`** — Main CircuitPython program. Runs on the Pico. All classes and logic in one file (CircuitPython has limited import support).
- **`install.py`** — Desktop Python script. Converts panipuri WAV samples (44100 Hz stereo → 22050 Hz mono) and deploys to CIRCUITPY drive. Uses only stdlib (`wave`, `struct`, `json`).
- **`pan_layout.json`** — Combined note layout + hardware configuration. Same `"notes"` format as panipuri, plus a `"hardware"` section for Pico pin assignments.

## code.py Structure

### Audio Players

- **`WavPlayer`** — Primary. Uses `audiomixer.Mixer` + `audiopwmio.PWMAudioOut`. 8-voice polyphony, round-robin allocation with voice stealing. Streams WAV files via `audiocore.WaveFile`. Velocity maps to volume via `(vel/127)^0.7`.
- **`TonePlayer`** — Fallback. Simple PWM square wave. Used when WAV files or audiomixer are unavailable.

Both expose the same interface: `note_on(midi, velocity)`, `note_off(midi)`, `all_off()`, `load_all(notes)`, `deinit()`.

### Input Handlers

- **`ButtonInput`** — Digital GPIO with pull-up, active low. Returns notes with no velocity (defaults to 100).
- **`TouchInput`** — Capacitive touch via `touchio`. Returns notes with no velocity.
- **`MuxTouchInput`** — Digital trigger + analog velocity via CD74HC4067 multiplexer. Select pins address the mux channel, ADC reads 0–3.3V, maps linearly to velocity 1–127. Returns notes with `"velocity"` key.

All expose: `scan()` → `(pressed_list, released_list)`, `.count` property.

### Utilities

- `note_to_midi(name, octave)` — e.g. `("C#", 4)` → `61`
- `midi_to_freq(midi)` — e.g. `60` → `261.6 Hz`
- `midi_to_filename(midi)` — e.g. `60` → `"C4.wav"`, `61` → `"Cs4.wav"`
- `midi_to_display(midi)` — e.g. `60` → `"C4"`, `61` → `"C#4"`
- `load_layout(path)` — Returns `(notes_list, hardware_dict)` from JSON
- `build_note_lookup(notes)` — Returns `(by_name, by_idx, by_midi)` dicts
- `find_note(id, ...)` — Looks up note by name+octave, layout idx, or MIDI number

### Demo Functions

- `play_demo(player, notes, tempo_bpm)` — Plays all notes sequentially
- `play_chord_demo(player, notes)` — Plays C, F, G, C chords

## Key Technical Details

- **Note range**: C4 (MIDI 60) to E6 (MIDI 88) — 29 tenor pan notes
- **Sound naming**: `sounds/{Note}{Octave}.wav`, sharps use lowercase `s` (e.g. `Cs4.wav` = C#4)
- **Audio**: `audiopwmio.PWMAudioOut` at 22050 Hz, 16-bit mono
- **Polyphony**: 8 voices, round-robin allocation
- **Scan rate**: 50 Hz (20ms per loop)
- **Mux settle time**: 1ms after channel switch before ADC read
- **Velocity curve**: `(velocity / 127.0) ** 0.7` — same as panipuri

## File Structure

```
code.py              # Main CircuitPython program (runs on Pico)
install.py           # Desktop: convert samples + deploy to Pico
pan_layout.json      # Note layout + hardware config
WIRING.md            # Wiring diagram for mux_touch mode
README.md            # User documentation
CLAUDE.md            # This file
.gitignore           # Excludes sounds_converted/, __pycache__/
sounds_converted/    # Converted WAVs (generated by install.py, not in git)
```

## pan_layout.json Format

```json
{
  "notes": [
    {"name": "C", "octave": 4, "ring": "outer", "idx": "O6"}
  ],
  "hardware": {
    "audio_pin": "GP18",
    "input_mode": "mux_touch",
    "max_voices": 8,
    "sample_rate": 22050,
    "sounds_dir": "sounds",
    "led_pin": "LED",
    "mux": {
      "analog_pin": "GP26",
      "select_pins": ["GP10", "GP11", "GP12", "GP13"]
    },
    "pins": {
      "GP0": {"note": "C4", "mux_channel": 0},
      "GP1": {"note": "D4", "mux_channel": 1}
    }
  }
}
```

Pin values can be a string (`"C4"`) for button/touch modes or a dict (`{"note": "C4", "mux_channel": 0}`) for mux_touch mode.

## Common Tasks

```bash
# Convert samples only (no Pico needed)
python install.py --convert-only

# Deploy to Pico
python install.py /Volumes/CIRCUITPY

# Preview what install would do
python install.py --dry-run

# Force re-convert all samples
python install.py --force

# Validate JSON
python -c "import json; json.load(open('pan_layout.json')); print('OK')"
```

## Dependencies

### On Pico (CircuitPython)
- `board`, `digitalio` — GPIO
- `audiopwmio` — PWM audio output
- `audiomixer` — polyphonic mixing
- `audiocore` — WAV file streaming
- `analogio` — ADC reading (mux_touch mode)
- `touchio` — capacitive touch (touch mode, optional)
- `json`, `time` — stdlib

### On Desktop (install.py)
- Python 3.8+
- No external dependencies (stdlib only: `wave`, `struct`, `json`, `shutil`, `argparse`)

## Relationship to panipuri

rpiPan is the embedded/hardware version of panipuri. Key differences:

| | panipuri | rpiPan |
|---|---------|--------|
| Platform | Desktop Python | CircuitPython on Pico |
| Audio | pygame.mixer (44100 Hz stereo) | audiopwmio + audiomixer (22050 Hz mono) |
| Input | Keyboard, MIDI, song files | GPIO buttons, touch, mux analog |
| Polyphony | 16 voices | 8 voices |
| Synthesis | Full synth engine (synth.py) | WAV samples only (no synthesis) |
| Config | pan_layout.json (notes only) | pan_layout.json (notes + hardware) |
